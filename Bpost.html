<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <?!= include('Bhead.html'); ?>
    <style>
      .hero-post{position:relative;border:1px solid var(--border);border-radius:12px;overflow:hidden}
      .hero-img{width:100%;height:340px;object-fit:cover;background:#eee}
      .hero-body{padding:14px}
      .hero-title{font-size:22px;color:#202124;font-weight:800;margin-bottom:6px}
      .hero-sub{font-size:14px;color:var(--text)}
      .hero-meta{display:flex;gap:14px;margin-top:8px;font-size:12px;color:var(--muted)}
      .layout{display:grid;grid-template-columns:1fr 320px;gap:20px;margin-top:18px}
      .slide{border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:16px}
      .s-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border-bottom:1px solid var(--border)}
      .author{display:flex;align-items:center;gap:10px}
      .ava{width:40px;height:40px;border-radius:50%;background:#eee;object-fit:cover}
      .an{font-weight:800;color:#202124;font-size:14px}
      .ar{font-size:12px;color:var(--muted)}
      .frame{position:relative;width:100%;padding-bottom:56.25%;background:#000}
      .frame > iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
      .s-meta{display:flex;gap:16px;padding:10px 12px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)}
      .side{position:sticky;top:90px;height:max-content;display:flex;flex-direction:column;gap:16px}
      .card{border:1px solid var(--border);border-radius:12px;background:#fff}
      .card-h{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:800;color:#202124}
      .card-b{padding:10px 12px}
      .tags{display:flex;flex-wrap:wrap;gap:8px}
      .tag{background:#e8f0fe;color:var(--primary);border:1px solid #d2e3fc;padding:6px 10px;border-radius:999px;font-size:12px}
      .sugg{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px}
      .sugg .card{cursor:pointer;transition:transform .2s}
      .sugg .card:hover{transform:translateY(-3px)}
      @media (max-width:980px){.layout{grid-template-columns:1fr}.sugg{grid-template-columns:1fr}}
    </style>
  </head>
  <body>
    <?!= include('Bui.html'); ?>

    <main class="wrap" style="padding:20px 0 30px">
      <section id="hero" class="hero-post" style="display:none">
        <img id="heroImg" class="hero-img" alt="" />
        <div class="hero-body">
          <h1 id="pt" class="hero-title"></h1>
          <p id="ps" class="hero-sub"></p>
          <div class="hero-meta">
            <span><i class="fa-regular fa-clock"></i><span id="rt"></span></span>
            <span><i class="fa-regular fa-calendar"></i><span id="da"></span></span>
            <span><i class="fa-solid fa-tag"></i><span id="cat"></span></span>
          </div>
        </div>
      </section>

      <section class="layout">
        <div id="slides"></div>

        <aside class="side">
          <div class="card">
            <div class="card-h">برچسب‌ها</div>
            <div id="tags" class="card-b tags"></div>
          </div>

          <div class="card">
            <div class="card-h">مطالب اخیر این دسته</div>
            <div id="recent" class="card-b">
              <div class="sugg" id="sugg"></div>
            </div>
          </div>
        </aside>
      </section>
    </main>

    <script>
      const params = new URLSearchParams(window.location.search);
      const postId = params.get('id') || '';

      function renderPost(p) {
        // Hero
        document.getElementById('hero').style.display = 'block';
        document.getElementById('heroImg').src = p.heroImage || '';
        document.getElementById('pt').textContent = p.title || '';
        document.getElementById('ps').textContent = p.subtitle || '';
        document.getElementById('rt').textContent = p.readingTime || '';
        document.getElementById('da').textContent = p.publishedAt || '';
        document.getElementById('cat').textContent = p.category || '';

        // Tags
        const tg = document.getElementById('tags'); tg.innerHTML = '';
        (p.tags || []).forEach(t=>{
          const s = document.createElement('span');
          s.className = 'tag'; s.textContent = t;
          tg.appendChild(s);
        });

        // Slides
        const box = document.getElementById('slides'); box.innerHTML = '';
        (p.slides||[]).forEach(s=>{
          const art = document.createElement('article');
          art.className = 'slide';
          art.innerHTML = `
            <div class="s-head">
              <div class="author">
                <img class="ava" src="${s.author.avatar||''}" alt="" />
                <div>
                  <div class="an">${s.author.name||''}</div>
                  <div class="ar">${s.publishedAt||''}</div>
                </div>
              </div>
              <div class="ar">اسلاید #${s.order||0}</div>
            </div>
            <div class="frame">
              <iframe src="${s.contentUrl||''}" referrerpolicy="no-referrer" loading="lazy"></iframe>
            </div>
            <div class="s-meta">
              <span><i class="fa-regular fa-heart"></i>${s.likesCount||0}</span>
              <span><i class="fa-regular fa-comment"></i>${s.commentsCount||0}</span>
              <span><i class="fa-regular fa-bookmark"></i>${s.savesCount||0}</span>
              <span><i class="fa-regular fa-share-from-square"></i>${s.shares||0}</span>
            </div>
          `;
          box.appendChild(art);
        });

        // Recent by category
        google.script.run
          .withSuccessHandler(list=>{
            const grid = document.getElementById('sugg'); grid.innerHTML = '';
            (list||[]).forEach(r=>{
              const card = document.createElement('article');
              card.className = 'card';
              card.onclick = ()=> {
                const url = new URL(window.location.href);
                url.search = '?view=post&id='+encodeURIComponent(r.postId);
                window.location.href = url.toString();
              };
              card.innerHTML = `
                <img class="thumb" src="${r.heroImage||''}" alt="" />
                <div class="body">
                  <h3 class="title" style="font-size:14px">${r.title||''}</h3>
                  <div class="meta"><span><i class="fa-regular fa-calendar"></i>${r.publishedAt||''}</span></div>
                </div>
              `;
              grid.appendChild(card);
            });
          })
          .withFailureHandler(err=>console.error(err))
          .getRecentByCategory(p.category, p.postId, 6);
      }

      function init() {
        if (!postId) {
          // اگر آیدی نبود برگرد به صفحه اصلی
          const base = '<?= ScriptApp.getService().getUrl() ?>';
          window.location.href = base;
          return;
        }
        google.script.run
          .withSuccessHandler(renderPost)
          .withFailureHandler(err=>{
            console.error(err);
            alert('پست یافت نشد');
            const base = '<?= ScriptApp.getService().getUrl() ?>';
            window.location.href = base;
          })
          .getPost(postId);
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
